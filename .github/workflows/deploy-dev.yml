name: Deploy Email Service DEV

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-dev:
    name: Deploy Email Service to DEV
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file with secrets
        run: |
          cat > .env << 'EOF'
          NODE_ENV=development
          PORT=3002
          MONGODB_USER=${{ secrets.MONGODB_USER }}
          MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }}
          MONGODB_DB=${{ secrets.MONGODB_DB }}
          MONGODB_URI=mongodb://${{ secrets.MONGODB_USER }}:${{ secrets.MONGODB_PASSWORD }}@mongodb:27017/${{ secrets.MONGODB_DB }}?authSource=admin
          IMAP_HOST=${{ secrets.IMAP_HOST }}
          IMAP_PORT=${{ secrets.IMAP_PORT }}
          IMAP_USER=${{ secrets.IMAP_USER }}
          IMAP_PASSWORD=${{ secrets.IMAP_PASSWORD }}
          IMAP_SECURE=true
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_SECURE=true
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL=${{ secrets.SMTP_FROM_EMAIL }}
          SMTP_FROM_NAME=${{ secrets.SMTP_FROM_NAME }}
          MAIN_APP_URL=${{ secrets.MAIN_APP_URL }}
          API_SECRET_KEY=${{ secrets.API_SECRET_KEY }}
          EMAIL_SERVICE_API_KEY=${{ secrets.EMAIL_SERVICE_API_KEY }}
          CHECK_INTERVAL_MS=60000
          IMAP_CHECK_INTERVAL_MS=60000
          ATTACHMENTS_PATH=attachments
          EOF

      - name: Deploy to DEV server
        run: |
          scp -i ~/.ssh/id_rsa .env ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:~/roady-devis-email/.env

          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            cd ~/roady-devis-email

            echo "🔄 Pulling latest code..."
            git fetch origin
            git checkout main
            git pull origin main

            echo "🌐 Ensuring Docker network exists..."
            docker network create roady-network 2>/dev/null || echo "Network already exists"

            echo "🛑 Stopping old services..."
            docker compose down || true

            echo "🔧 Building and starting services..."
            docker compose up -d --build

            echo "⏳ Waiting for services to be healthy..."
            sleep 20

            echo "🔍 Checking services status..."
            docker compose ps

            echo "✅ Email Service deployment complete!"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -f .env

      - name: Health check
        run: |
          sleep 5
          echo "✅ Email Service deployed!"
